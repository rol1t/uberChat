<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>SignalR Chat</title>
    <link type="text/css" rel="stylesheet" href="style.css" />
</head>

<body>
    <div id="loginDiv">
        <input type="text" id="login" />
        <input type="button" id="registerBtn" value="Войти в глобальную группу" />
    </div>
    <div id="chatSelector">
        <input type="text" id="groupNameBox" placeholder="groupName" />
        <input type="button" id="selectGroupBtn" value="Войти в произвольную группу" />
    </div>
    <br />
    <h2 id="chatName"></h2>
    <div id="chatroom"></div>

    <div id="chatspace">
        <div id="onlineUsers">
            <h3>Пользователи онлайн</h3>
            <p id="userList"></p>
        </div>
        <div id="messages"></div>
        <div id="chatUsers"></div>
        <input type="button" id="loadMore" value="Загрузить еще">

    </div>
    <br>
    <div id="inputForm">
        <input type="text" id="message" />
        <input type="button" id="sendBtn" value="Отправить" />
    </div>
    <br>
    <div id="privateForm">
        <input type="text" id="privateMessage" />
        <input type="text" id="reciver" placeholder="id#name (-124#rolit)" />
        <input type="button" id="sendBtnPrivate" value="Отправить" />
    </div>
    <script src="js/signalr/dist/browser/signalr.js"></script>
    <script>
        let firstMessageId = 0;
        const hubConnection = new signalR.HubConnectionBuilder()
            .withUrl("/chat")
            .build();

        function insertAfter(newNode, referenceNode) {
            referenceNode.parentNode.insertBefore(newNode, referenceNode.nextSibling);
        }

        function displayMessage(message, isHighlated = false, color = "black") {
            let elem = document.createElement("p");
            elem.style.color = color;
            let firstChild = document.getElementById("messages").firstChild;
            if (isHighlated) {
                message = `!!! ${String(message).toUpperCase()} !!!`;
            } else {
                elem.value = message;
            }
            elem.innerHTML = message;
            document.getElementById("messages").insertBefore(elem, firstChild);
             
        }

        function displayMessageAfter(message) {
            let elem = document.createElement("p");
            let lastChild = document.getElementById("messages").lastChild;
            elem.innerHTML = message;
            insertAfter(elem, lastChild);
        }

        function clearChat() {
            document.getElementById("messages").innerHTML = "";
        }

        document.getElementById("selectGroupBtn").addEventListener("click", (e) => {
            hubConnection.invoke("ConnectToGroup", document.getElementById("groupNameBox").value);
        });

        hubConnection.on("UserConnected", function (user) {
            console.log(user);
            document.getElementById("userList").innerHTML = user;
        });

        hubConnection.on("ReciveMessage", (userName, message) => {
            displayMessage(userName + ": " + message);
        });

        hubConnection.on("Notify", (message) => {
            displayMessage(message, true, "red");
        });

        document.getElementById("registerBtn").addEventListener("click", (e) => {
            hubConnection.invoke("Connect", { Name: document.getElementById("login").value }).catch((reason) => console.log(reason));
        });


        hubConnection.on("ConnectToChat2", (chat) => {
            console.log(chat);
        });

        document.getElementById("sendBtn").addEventListener("click", (e) => {
            hubConnection.invoke("SendMessage", document.getElementById("message").value);
        });

        document.getElementById("sendBtnPrivate").addEventListener("click", (e) => {
            let privateMessage = document.getElementById("privateMessage").value;
            let reciver = document.getElementById("reciver").value;
            hubConnection.invoke("SendPrivateMessage", reciver, privateMessage)
        });
        hubConnection.on("PrivateMessage", (reciver, message) => {
            let firstChild = document.getElementById("messages").firstChild;
            let elem = document.createElement("p");
            elem.innerHTML = reciver + ": " + message;
            elem.style.color = "#ff1482";
            document.getElementById("messages").insertBefore(elem, firstChild);
        });
        hubConnection.on("ConnectToChat", (userChat) => {
            chat1 = userChat;
            loadChat(chat1);
        });

        hubConnection.on("UpdateChat", (userChat) => {
            chat1 = userChat;
            loadChat(userChat);
        });

        hubConnection.on("LoadMessages", (messages, firstId) => {
            clearChat();
            messages.forEach(elem => {
                displayMessage(`${elem.sender}: ${elem.content}`);
            });
            firstMessageId = firstId;
        });
        hubConnection.on("LoadMoreMessages", (messages, firstId) => {
            messages.forEach(elem => {
                displayMessageAfter(`${elem.sender}: ${elem.content}`);
            });
            firstMessageId = firstId;
        });
        document.getElementById("loadMore").addEventListener("click", (e) => {
            hubConnection.invoke("LoadMore", firstMessageId);
        });

        hubConnection.start();
    </script>
</body>

</html>